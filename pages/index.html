<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vesso - The Task Manager</title>
  <link rel="icon" type="image/x-icon" href="/assets/favicon.ico" />
  <link rel="stylesheet" href="/css/global.css" />
</head>

<body>

  <!-- Profile -->
  <div id="profile_visit">
    <button id="user_name" class="profile-button"></button>
  </div>

  <div id="user_card" class="user-card">
    <div class="user-info">
      <h5 id="user_name_label"></h5>
    </div>
    <button id="log_out" class="profile-action-button">Log out</button>
  </div>

  <!-- Layout -->
  <div class="app-layout">

    <!-- Sidebar -->
    <aside class="tasks-sidebar">
      <div class="sidebar-header">
        <button id="Add_New" class="button button-primary">Add New +</button>
      </div>

      <div id="task_list_sidebar" class="task-list-sidebar"></div>

      <div class="recycle-button-container">
        <button class="button button-secondary" id="bin">Bin</button>
      </div>
    </aside>

    <!-- Main View -->
    <main class="task-detail-area">

      <div id="empty_state" class="empty-state">
        <h2>Select a task to view details</h2>
        <p>Click a task from the sidebar</p>
      </div>

      <div id="expanded_task_view" class="expanded-task-view"></div>
    </main>
  </div>

  <!-- Add Task Modal -->
  <div id="add_task_backdrop" class="modal-backdrop"></div>
  <div id="add_task_form" class="task-form task-form-modal">
    <div class="form-group">
      <h4>Name of task</h4>
      <input id="task_name_form" type="text" />
    </div>
    <div class="form-group">
      <h4>Add description</h4>
      <input id="task_description_from" type="text" />
    </div>
    <div class="form-actions">
      <button id="back" class="button">Back</button>
      <button id="add" class="button button-primary">Add</button>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div id="edit_backdrop" class="modal-backdrop"></div>
  <div id="edit" class="task-form task-form-modal">
    <div class="form-group">
      <h4>Name of task</h4>
      <input id="edit_name_form" type="text" />
    </div>
    <div class="form-group">
      <h4>Add description</h4>
      <input id="edit_description_from" type="text" />
    </div>
    <div class="form-actions">
      <button id="back_from_edit" class="button">Back</button>
      <button id="do_edit" class="button button-primary">Save</button>
    </div>
  </div>

  <!-- ðŸ”´ SOURCE OF TRUTH (hidden, but real) -->
  <div id="task_card_show_area" style="display:none;"></div>

  <!-- External JS -->
  <script type="module" src="/js/logout.js"></script>
  <script type="module" src="/js/getUser.js"></script>
  <script type="module" src="/js/createTask.js"></script>
  <script type="module" src="/js/getAllTask.js"></script>
  <script type="module" src="/js/moveToBin.js"></script>
  <script type="module" src="/js/completeTask.js"></script>
  <script type="module" src="/js/editTask.js"></script>

  <!-- UI Logic -->
  <script>
    // Profile toggle
    const profileButton = document.getElementById("user_name");
    const userCard = document.getElementById("user_card");

    profileButton.addEventListener("click", (e) => {
      e.stopPropagation();
      userCard.style.display =
        userCard.style.display === "block" ? "none" : "block";
    });

    document.addEventListener("click", () => {
      userCard.style.display = "none";
    });

    // Bin navigation
    document.getElementById("bin")?.addEventListener("click", () => {
      window.location.href = "/pages/bin.html";
    });
    
    const addNewBtn = document.getElementById("Add_New");
    const addTaskBackdrop = document.getElementById("add_task_backdrop");
    const addTaskForm = document.getElementById("add_task_form");
    const backBtn = document.getElementById("back");

    // Open modal
    addNewBtn?.addEventListener("click", () => {
      addTaskBackdrop.style.display = "block";
      addTaskBackdrop.classList.add("active");
      addTaskForm.style.display = "block";
    });

    // Close modal on back button
    backBtn?.addEventListener("click", () => {
      addTaskBackdrop.style.display = "none";
      addTaskBackdrop.classList.remove("active");
      addTaskForm.style.display = "none";
      // Clear form fields
      document.getElementById("task_name_form").value = "";
      document.getElementById("task_description_from").value = "";
    });

    // Close modal on backdrop click
    addTaskBackdrop?.addEventListener("click", () => {
      addTaskBackdrop.style.display = "none";
      addTaskBackdrop.classList.remove("active");
      addTaskForm.style.display = "none";
      // Clear form fields
      document.getElementById("task_name_form").value = "";
      document.getElementById("task_description_from").value = "";
    });

    let selectedTaskId = null;

    const taskArea = document.getElementById("task_card_show_area");
    const sidebar = document.getElementById("task_list_sidebar");
    const expanded = document.getElementById("expanded_task_view");
    const empty = document.getElementById("empty_state");

    // Observe ONLY the real task container
    new MutationObserver(updateUI).observe(taskArea, {
      childList: true,
      subtree: true,
    });

    document.addEventListener("taskStatusChanged", (e) => {
      const { taskId, isCompleted } = e.detail;
      const sidebarItem = sidebar.querySelector(`[data-task-id="${taskId}"]`);
      
      if (sidebarItem) {
        if (isCompleted) {
          sidebarItem.classList.add("completed");
        } else {
          sidebarItem.classList.remove("completed");
        }
      }
    });

    function updateUI() {
      const cards = taskArea.querySelectorAll(".task-card");
      sidebar.innerHTML = "";

      if (cards.length === 0) {
        empty.style.display = "flex";
        expanded.style.display = "none";
        return;
      }

      empty.style.display = "none";

      const sortedCards = Array.from(cards).sort((a, b) => {
        const aCompleted = a.dataset.isCompleted === "true";
        const bCompleted = b.dataset.isCompleted === "true";
        return aCompleted - bCompleted;
      });

      sortedCards.forEach((card, index) => {
        const taskId = card.dataset.taskId;
        const isCompleted = card.dataset.isCompleted === "true";

        const item = document.createElement("div");
        item.className = isCompleted ? "sidebar-task-item completed" : "sidebar-task-item";
        item.dataset.taskId = taskId;

        item.innerHTML = `
          <h4 class="sidebar-task-title">${card.querySelector(".task-title")?.textContent || ""}</h4>
          <p class="sidebar-task-preview">${card.querySelector(".task-description")?.textContent || ""}</p>
        `;

        item.addEventListener("click", () => {
          selectedTaskId = taskId;

          sidebar.querySelectorAll(".sidebar-task-item").forEach(i => i.classList.remove("active"));
          item.classList.add("active");

          expanded.innerHTML = "";
          expanded.appendChild(card.cloneNode(true));
          expanded.style.display = "block";
        });

        sidebar.appendChild(item);

        if (index === 0 && !selectedTaskId) item.click();
      });
    }
  </script>

</body>
</html>
